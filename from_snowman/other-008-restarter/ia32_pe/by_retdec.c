//
// This file was generated by the Retargetable Decompiler
// Website: https://retdec.com
// Copyright (c) 2018 Retargetable Decompiler <info@retdec.com>
//

#include <stdbool.h>
#include <stdint.h>
#include <stdlib.h>
#include <windows.h>

// ------------------------ Structures ------------------------

struct _FILETIME {
    int32_t e0;
    int32_t e1;
};

struct _WIN32_FIND_DATAW {
    int32_t e0;
    struct _FILETIME e1;
    struct _FILETIME e2;
    struct _FILETIME e3;
    int32_t e4;
    int32_t e5;
    int32_t e6;
    int32_t e7;
    int16_t e8[1];
    int16_t e9[14];
    int32_t e10;
    int32_t e11;
    int16_t e12;
};

// ------------------- Function Prototypes --------------------

int16_t * entry_point(void);
int32_t function_401000(int16_t * a1, int32_t a2, int32_t a3);
bool function_4010a0(int32_t a1);

// --------------------- Global Variables ---------------------

int32_t g1 = 0; // eax
int32_t g2 = 0; // ebx
int32_t g3 = 0; // ecx
int32_t g4 = 0; // edi
int32_t g5 = 0; // esi
int32_t g6 = -0x17f38475; // 0x4011ff
int32_t g7 = 0xe75c085; // 0x40121e
int32_t g8 = 0xb75c085; // 0x401277

// ------------------------ Functions -------------------------

// Address range: 0x401000 - 0x40109f
int32_t function_401000(int16_t * a1, int32_t a2, int32_t a3) {
    int32_t errorCode = GetLastError(); // 0x40100b
    g4 = errorCode;
    int32_t lpBuffer;
    FormatMessageW(0x1300, NULL, errorCode, 1024, (int16_t *)&lpBuffer, 0, NULL);
    int32_t v1 = lstrlenW((int16_t *)lpBuffer); // 0x401038
    int32_t uBytes = 2 * (lstrlenW((int16_t *)g1) + v1) + 0x2000; // 0x401045
    char * memoryHandle = LocalAlloc(64, uBytes); // 0x40104f
    g3 = (int32_t)a1;
    g5 = (int32_t)memoryHandle;
    wsprintfW((int16_t *)memoryHandle, L"\x041f\x0440\x0438\x0020\x043e\x0431\x043d\x043e\x0432\x043b\x0435\x043d\x0438\x0438\x0020\x043f\x0440\x043e\x0438\x0437\x043e\x0448\x043b\x0430\x0020\x043e\x0448\x0438\x0431\x043a\x0430\x002e\x0020\x041f\x043e\x0436\x0430\x043b\x0443\x0439\x0441\x0442\x0430\x002c\x0020\x0437\x0430\x0433\x0440\x0443\x0437\x0438\x0442\x0435\x0020\x043e\x0431\x043d\x043e\x0432\x043b\x0435\x043d\x0438\x0435\x0020\x0441\x0430\x043c\x043e\x0441\x0442\x043e\x044f\x0442\x0435\x043b\x044c\x043d\x043e\x002e\x0020\x000a\x000a\x0414\x043e\x043f\x043e\x043b\x043d\x0438\x0442\x0435\x043b\x044c\x043d\x0430\x044f\x0020\x0438\x043d\x0444\x043e\x0440\x043c\x0430\x0446\x0438\x044f\x0020\x043e\x0020\x043f\x0440\x043e\x0438\x0437\x043e\x0448\x0435\x0434\x0448\x0435\x0439\x0020\x043e\x0448\x0438\x0431\x043a\x0435\x003a\x000a\x0025\x0073\x0028\x0025\x0073\x0029\x0020\x0066\x0061\x0069\x006c\x0065\x0064\x0020\x0077\x0069\x0074\x0068\x0020\x0065\x0072\x0072\x006f\x0072\x0020\x0025\x0064\x003a\x0020\x0025\x0073\x000a\x041f\x043e\x0436\x0430\x043b\x0443\x0439\x0441\x0442\x0430\x002c\x0020\x0441\x043e\x043e\x0431\x0449\x0438\x0442\x0435\x0020\x043e\x0431\x0020\x044d\x0442\x043e\x043c\x0020\x0440\x0430\x0437\x0440\x0430\x0431\x043e\x0442\x0447\x0438\x043a\x0430\x043c\x002e\x0020\x0421\x043f\x0430\x0441\x0438\x0431\x043e\x002e");
    int16_t * lpCaption = L"Error"; // bp-24
    *(int16_t *)(g5 + 2048) = 0;
    MessageBoxW(NULL, (int16_t *)g5, lpCaption, (int32_t)NULL);
    g2 = 0x2462;
    LocalFree((char *)lpBuffer);
    LocalFree((char *)g5);
    ExitProcess(g4);
    // UNREACHABLE
}

// Address range: 0x4010a0 - 0x40112f
bool function_4010a0(int32_t a1) {
    int32_t v1 = g2; // 0x4010a9
    int32_t v2 = g5; // bp-604
    g5 = 0;
    if (!DeleteFileW((int16_t *)g4)) {
        // 0x4010c5
        SetFileAttributesW((int16_t *)g4, 128);
        if (!DeleteFileW((int16_t *)g4)) {
            // 0x4010d8
            g2 = 0x23d6;
            // branch -> 0x4010e0
            while (true) {
                // 0x4010e0
                if (!DeleteFileW((int16_t *)g4)) {
                    // 0x4010eb
                    int32_t lpFindFileData;
                    char * hFindFile = FindFirstFileW((int16_t *)g4, (struct _WIN32_FIND_DATAW *)&lpFindFileData); // 0x4010f3
                    if (hFindFile == (char *)-1) {
                        int32_t errorCode = GetLastError(); // 0x4010fe
                        g1 = errorCode;
                        if (errorCode == 2) {
                            // 0x4010ba
                            g5 = v2;
                            g2 = v1;
                            return true;
                        }
                    } else {
                        // 0x40110b
                        g1 = FindClose(hFindFile);
                        // branch -> 0x401112
                    }
                    // 0x401112
                    ((int32_t (*)(int32_t))g2)(100);
                    int32_t v3 = g5 + 1; // 0x401116
                    g5 = v3;
                    if (v3 >= 10) {
                        // break -> 0x40111c
                        break;
                    }
                    // continue -> 0x4010e0
                    continue;
                }
            }
            // 0x40111c
            g5 = (int32_t)(struct _WIN32_FIND_DATAW *)100;
            g2 = v2;
            return false;
        }
    }
    // 0x4010ba
    g5 = v2;
    g2 = v1;
    return true;
}

// Address range: 0x401130 - 0x4012a5
int16_t * entry_point(void) {
    int32_t v1 = 0; // esp
    int32_t v2 = g5; // 0x40113a
    int32_t v3 = g4; // bp-112
    int32_t v4 = &v3; // 0x40113b_0
    int32_t v5;
    int16_t ** v6 = CommandLineToArgvW(GetCommandLineW(), (int32_t *)(int32_t)&v5); // 0x401148
    g2 = (int32_t)v6;
    if (v6 == NULL) {
        // 0x401154
        g1 = (int32_t)L"CommandLineToArgvW";
        function_401000(L"", v3, v2);
        // branch -> 0x401163
    }
    int32_t v7 = v5; // 0x401163
    if (v7 != 5) {
        // 0x40116c
        return (int16_t *)(v7 + 1000);
    }
    int32_t v8 = *(int32_t *)(g2 + 4); // 0x40117a
    g4 = v8;
    g3 = 0;
    int32_t v9;
    if (v8 != 0) {
        int32_t v10 = 20; // 0x401190
        // branch -> 0x401188
        while (true) {
            // 0x401188
            if (*(int16_t *)v8 == 0) {
                // 0x4011d3
                // branch -> 0x401195
            } else {
                int32_t v11 = v10 - 1; // 0x401190
                if (v11 == 0) {
                    // break -> 0x401195
                    break;
                }
                v10 = v11;
                v8 += 2;
                // continue -> 0x401188
                continue;
            }
            // 0x401195
            v9 = 20 - v10;
            // branch -> 0x401195
          lab_0x401195:
            while (true) {
                // 0x401195
                int32_t v12; // 0x401243
                int32_t v13; // 0x40125b
                int32_t * v14; // 0x4011f8_0
                int32_t * v15; // 0x401216_0
                int32_t * v16; // 0x401217_0
                int32_t * v17; // 0x401263_0
                int32_t * v18; // 0x401268_0
                char * hProcess; // 0x4011b5
                bool v19; // 0x4011df
                bool v20; // 0x401202
                bool v21; // 0x401218
                int32_t v22;
                int32_t v23;
                int32_t v24; // 0x4011f8
                int32_t v25; // 0x401216
                int32_t v26; // 0x40120b
                int32_t v27; // 0x401235
                int32_t v28; // 0x40125f
                int32_t v29; // 0x401286
                int32_t v30; // 0x401235
                int32_t v31; // 0x401244
                int32_t v32; // 0x401254
                int32_t v33; // 0x40125c
                int32_t v34; // 0x401298
                if (v9 == 0) {
                    // 0x401195
                    // branch -> 0x4011b0
                } else {
                    int32_t v35 = 0; // 0x4011a4
                    int32_t v36 = v35 + 1; // 0x4011a4
                    int32_t dwProcessId = 10 * g3 - 48 + (int32_t)*(int16_t *)(2 * v35 + g4); // 0x4011a8
                    g3 = dwProcessId;
                    // branch -> 0x4011a0
                    while (v36 < v9) {
                        // 0x4011a0
                        v35 = v36;
                        v36 = v35 + 1;
                        dwProcessId = 10 * dwProcessId - 48 + (int32_t)*(int16_t *)(2 * v35 + g4);
                        g3 = dwProcessId;
                        // continue -> 0x4011a0
                    }
                    // 0x4011b0
                    hProcess = OpenProcess(1, false, dwProcessId);
                    g5 = (int32_t)hProcess;
                    if (hProcess == NULL) {
                      lab_0x4011cf:
                        // 0x4011cf
                        g1 = (int32_t)L"OpenProcess";
                        function_401000((int16_t *)*(int32_t *)(g2 + 4), v3, v2);
                        if (g5 != 0) {
                            // break -> 0x4011d3
                            break;
                        }
                        v9 = 0;
                        // continue -> 0x401195
                        continue;
                    } else {
                        // 0x4011dc
                        v19 = TerminateProcess(hProcess, 0);
                        v24 = v4;
                        if (!v19) {
                            // 0x4011e9
                            g1 = (int32_t)L"TerminateProcess";
                            function_401000(L"", v3, v2);
                            v24 = v1;
                            // branch -> 0x4011f8
                        }
                        // 0x4011f8
                        v14 = (int32_t *)(v24 - 4);
                        *v14 = g5;
                        *(int32_t *)(v24 - 8) = (int32_t)&g6;
                        CloseHandle(NULL);
                        g4 = *(int32_t *)(g2 + 12);
                        *v14 = 0x401207;
                        v20 = function_4010a0(0);
                        v26 = g2;
                        v23 = *(int32_t *)((!v20 ? 16 : 12) + v26);
                        g5 = v23;
                        v25 = v1;
                        v15 = (int32_t *)(v25 - 4);
                        *v15 = v23;
                        v16 = (int32_t *)(v25 - 8);
                        *v16 = *(int32_t *)(v26 + 8);
                        *(int32_t *)(v25 - 12) = (int32_t)&g7;
                        v21 = MoveFileW(NULL, NULL);
                        v27 = v25;
                        if (!v21) {
                            // 0x401222
                            *v15 = *(int32_t *)(g2 + 8);
                            g1 = (int32_t)L"MoveFileW";
                            *v16 = 0x401230;
                            function_401000(NULL, 0, 0);
                            v27 = v1;
                            // branch -> 0x401230
                        }
                        // 0x401230
                        v30 = v27 + 32;
                        *(char *)v30 = 0;
                        v12 = v30 + 1;
                        v31 = 67;
                        // branch -> 0x401240
                        while (v31 != 0) {
                            // 0x401240
                            *(char *)v12 = 0;
                            v12++;
                            v31--;
                            // continue -> 0x401240
                        }
                        // 0x401247
                        *(int32_t *)(v1 + 32) = 68;
                        g3 = 16;
                        v32 = v1 + 16;
                        *(char *)v32 = 0;
                        v13 = v32 + 1;
                        v33 = g3 - 1;
                        g3 = v33;
                        // branch -> 0x401258
                        while (v33 != 0) {
                            // 0x401258
                            *(char *)v13 = 0;
                            v13++;
                            v33 = g3 - 1;
                            g3 = v33;
                            // continue -> 0x401258
                        }
                        // 0x40125f
                        v28 = v1;
                        v17 = (int32_t *)(v28 - 4);
                        *v17 = v28 + 16;
                        v18 = (int32_t *)(v28 - 8);
                        *v18 = v28 + 32;
                        *(int32_t *)(v28 - 12) = g3;
                        *(int32_t *)(v28 - 16) = g3;
                        *(int32_t *)(v28 - 20) = g3;
                        *(int32_t *)(v28 - 24) = g3;
                        *(int32_t *)(v28 - 28) = g3;
                        *(int32_t *)(v28 - 32) = g3;
                        *(int32_t *)(v28 - 36) = g5;
                        *(int32_t *)(v28 - 40) = g3;
                        *(int32_t *)(v28 - 44) = (int32_t)&g8;
                        if (!CreateProcessW(NULL, NULL, NULL, NULL, (v22 & 1) != 0, 0, NULL, NULL, NULL, NULL)) {
                            // 0x40127b
                            *v17 = g5;
                            g1 = (int32_t)L"CreateProcessW";
                            *v18 = 0x401286;
                            function_401000(NULL, 0, 0);
                            // branch -> 0x401286
                        }
                        // 0x401286
                        v29 = g2;
                        if (g5 == *(int32_t *)(v29 + 12)) {
                            // 0x40129b
                            return NULL;
                        }
                        // 0x40128b
                        g5 = 100;
                        int32_t v37 = v29; // 0x401290
                        // branch -> 0x401290
                        while (true) {
                            // 0x401290
                            g4 = *(int32_t *)(v37 + 12);
                            *(int32_t *)(v1 - 4) = 0x401298;
                            function_4010a0(0);
                            v34 = g5 - 1;
                            g5 = v34;
                            if (v34 == 0) {
                                // 0x40129b
                                return NULL;
                            }
                          lab_0x401290:
                            // 0x401290
                            v37 = g2;
                            // branch -> 0x401290
                        }
                    }
                }
                // 0x4011b0
                hProcess = OpenProcess(1, false, g3);
                g5 = (int32_t)hProcess;
                if (hProcess == NULL) {
                    goto lab_0x4011cf;
                }
                // 0x4011dc
                v19 = TerminateProcess(hProcess, 0);
                v24 = v4;
                if (!v19) {
                    // 0x4011e9
                    g1 = (int32_t)L"TerminateProcess";
                    function_401000(L"", v3, v2);
                    v24 = v1;
                    // branch -> 0x4011f8
                }
                // 0x4011f8
                v14 = (int32_t *)(v24 - 4);
                *v14 = g5;
                *(int32_t *)(v24 - 8) = (int32_t)&g6;
                CloseHandle(NULL);
                g4 = *(int32_t *)(g2 + 12);
                *v14 = 0x401207;
                v20 = function_4010a0(0);
                v26 = g2;
                v23 = *(int32_t *)((!v20 ? 16 : 12) + v26);
                g5 = v23;
                v25 = v1;
                v15 = (int32_t *)(v25 - 4);
                *v15 = v23;
                v16 = (int32_t *)(v25 - 8);
                *v16 = *(int32_t *)(v26 + 8);
                *(int32_t *)(v25 - 12) = (int32_t)&g7;
                v21 = MoveFileW(NULL, NULL);
                v27 = v25;
                if (!v21) {
                    // 0x401222
                    *v15 = *(int32_t *)(g2 + 8);
                    g1 = (int32_t)L"MoveFileW";
                    *v16 = 0x401230;
                    function_401000(NULL, 0, 0);
                    v27 = v1;
                    // branch -> 0x401230
                }
                // 0x401230
                v30 = v27 + 32;
                *(char *)v30 = 0;
                v12 = v30 + 1;
                v31 = 67;
                // branch -> 0x401240
                while (v31 != 0) {
                    // 0x401240
                    *(char *)v12 = 0;
                    v12++;
                    v31--;
                    // continue -> 0x401240
                }
                // 0x401247
                *(int32_t *)(v1 + 32) = 68;
                g3 = 16;
                v32 = v1 + 16;
                *(char *)v32 = 0;
                v13 = v32 + 1;
                v33 = g3 - 1;
                g3 = v33;
                // branch -> 0x401258
                while (v33 != 0) {
                    // 0x401258
                    *(char *)v13 = 0;
                    v13++;
                    v33 = g3 - 1;
                    g3 = v33;
                    // continue -> 0x401258
                }
                // 0x40125f
                v28 = v1;
                v17 = (int32_t *)(v28 - 4);
                *v17 = v28 + 16;
                v18 = (int32_t *)(v28 - 8);
                *v18 = v28 + 32;
                *(int32_t *)(v28 - 12) = g3;
                *(int32_t *)(v28 - 16) = g3;
                *(int32_t *)(v28 - 20) = g3;
                *(int32_t *)(v28 - 24) = g3;
                *(int32_t *)(v28 - 28) = g3;
                *(int32_t *)(v28 - 32) = g3;
                *(int32_t *)(v28 - 36) = g5;
                *(int32_t *)(v28 - 40) = g3;
                *(int32_t *)(v28 - 44) = (int32_t)&g8;
                if (!CreateProcessW(NULL, NULL, NULL, NULL, (v22 & 1) != 0, 0, NULL, NULL, NULL, NULL)) {
                    // 0x40127b
                    *v17 = g5;
                    g1 = (int32_t)L"CreateProcessW";
                    *v18 = 0x401286;
                    function_401000(NULL, 0, 0);
                    // branch -> 0x401286
                }
                // 0x401286
                v29 = g2;
                if (g5 == *(int32_t *)(v29 + 12)) {
                    // 0x40129b
                    return NULL;
                }
                // 0x40128b
                g5 = 100;
                // branch -> 0x401290
                while (true) {
                    // 0x401290
                    g4 = *(int32_t *)(v29 + 12);
                    *(int32_t *)(v1 - 4) = 0x401298;
                    function_4010a0(0);
                    v34 = g5 - 1;
                    g5 = v34;
                    if (v34 != 0) {
                        goto lab_0x401290;
                    }
                    // 0x40129b
                    return NULL;
                }
            }
        }
    }
    // 0x401195
    v9 = 0;
    // branch -> 0x401195
    goto lab_0x401195;
}

// --------------- Dynamically Linked Functions ---------------

// BOOL CloseHandle(_In_ HANDLE hObject);
// LPWSTR * CommandLineToArgvW(_In_ LPCWSTR lpCmdLine, _Out_ int * pNumArgs);
// BOOL CreateProcessW(_In_opt_ LPCWSTR lpApplicationName, _Inout_opt_ LPWSTR lpCommandLine, _In_opt_ LPSECURITY_ATTRIBUTES lpProcessAttributes, _In_opt_ LPSECURITY_ATTRIBUTES lpThreadAttributes, _In_ BOOL bInheritHandles, _In_ DWORD dwCreationFlags, _In_opt_ LPVOID lpEnvironment, _In_opt_ LPCWSTR lpCurrentDirectory, _In_ LPSTARTUPINFOW lpStartupInfo, _Out_ LPPROCESS_INFORMATION lpProcessInformation);
// BOOL DeleteFileW(_In_ LPCWSTR lpFileName);
// VOID ExitProcess(_In_ UINT uExitCode);
// BOOL FindClose(_Inout_ HANDLE hFindFile);
// HANDLE FindFirstFileW(_In_ LPCWSTR lpFileName, _Out_ LPWIN32_FIND_DATAW lpFindFileData);
// DWORD FormatMessageW(_In_ DWORD dwFlags, _In_opt_ LPCVOID lpSource, _In_ DWORD dwMessageId, _In_ DWORD dwLanguageId, _Out_ LPWSTR lpBuffer, _In_ DWORD nSize, _In_opt_ va_list * Arguments);
// LPWSTR GetCommandLineW(VOID);
// DWORD GetLastError(VOID);
// HLOCAL LocalAlloc(_In_ UINT uFlags, _In_ SIZE_T uBytes);
// HLOCAL LocalFree(HLOCAL hMem);
// int lstrlenW(_In_ LPCWSTR lpString);
// int MessageBoxW(_In_opt_ HWND hWnd, _In_opt_ LPCWSTR lpText, _In_opt_ LPCWSTR lpCaption, _In_ UINT uType);
// BOOL MoveFileW(_In_ LPCWSTR lpExistingFileName, _In_ LPCWSTR lpNewFileName);
// HANDLE OpenProcess(_In_ DWORD dwDesiredAccess, _In_ BOOL bInheritHandle, _In_ DWORD dwProcessId);
// BOOL SetFileAttributesW(_In_ LPCWSTR lpFileName, _In_ DWORD dwFileAttributes);
// BOOL TerminateProcess(_In_ HANDLE hProcess, _In_ UINT uExitCode);
// int wsprintfW(_Out_ LPWSTR, _In_ LPCWSTR, ...);

// --------------------- Meta-Information ---------------------

// Detected compiler/packer: microsoft linker (10.0)
// Detected functions: 3
// Decompiler release: VERSION
// Decompilation date: DATE

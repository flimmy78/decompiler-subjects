// subject.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 00401060: void fn00401060(Stack Eq_2 dwArg04, Stack Eq_3 dwArg08, Stack Eq_3 dwArg0C)
void fn00401060(Eq_2 dwArg04, Eq_3 dwArg08, Eq_3 dwArg0C)
{
	Eq_3 dwLoc08_16 = 0x00;
	while (dwLoc08_16 < dwArg0C)
	{
		Mem30[dwArg04 + dwLoc08_16:byte] = Mem0[dwArg08 + dwLoc08_16:byte];
		dwLoc08_16 = (word32) dwLoc08_16 + 0x01;
	}
}

// 004010A0: void fn004010A0(Stack Eq_3 dwArg04, Stack Eq_3 dwArg08, Stack Eq_16 dwArg0C)
void fn004010A0(Eq_3 dwArg04, Eq_3 dwArg08, Eq_16 dwArg0C)
{
	if (RegOpenKeyA((struct HKEY__ *) 0x80000002, 0x00408070, fp - 0x20) != 0x00)
	{
		Eq_30 dl_56 = *dwArg04;
		Eq_16 dwLoc0C_114 = 0x01;
		int32 dwLoc18_112 = 0x00;
		do
		{
			Eq_16 edx_75 = (word32) dwLoc0C_114 + 0x01;
			byte cl_72 = Mem0[dwArg04 + dwLoc0C_114:byte];
			dwLoc0C_114 = edx_75;
			if ((word32) cl_72 == (word32) dl_56)
			{
				if ((word32) Mem0[dwArg04 + edx_75:byte] == 0x00)
				{
					*((word32) dwArg08 + dwLoc18_112) = dl_56;
					dwLoc18_112 = dwLoc18_112 + 0x01;
					dwLoc0C_114 = (word32) edx_75.u0 + 0x01;
				}
				else
				{
					word32 eax_141 = fn004011D0(fp - 0x10, dwArg04 + edx_75) + edx_75;
					dwLoc0C_114 = fn004011D0(fp - 0x24, (word32) dwArg04 + eax_141) + eax_141;
					uint32 dwLoc1C_158 = 0x00;
					while (dwLoc1C_158 < dwLoc10)
					{
						*((word32) dwArg08 + dwLoc18_112) = *((word32) dwArg08 + (dwLoc18_112 - dwLoc24));
						dwLoc18_112 = dwLoc18_112 + 0x01;
						dwLoc1C_158 = dwLoc1C_158 + 0x01;
					}
				}
			}
			else
			{
				*((word32) dwArg08 + dwLoc18_112) = cl_72;
				dwLoc18_112 = dwLoc18_112 + 0x01;
			}
		} while (dwLoc0C_114 < dwArg0C);
	}
}

// 004011D0: Register word32 fn004011D0(Stack (ptr ui32) dwArg04, Stack (ptr byte) dwArg08)
word32 fn004011D0(ui32 * dwArg04, byte * dwArg08)
{
	LoadIconA(null, 0x7F00);
	ui32 dwLoc08_14 = 0x00;
	word32 dwLoc10_15 = 0x00;
	do
	{
		ui32 ecx_22 = (word32) *dwArg08;
		ui32 eax_31 = dwLoc08_14 << 0x07 | ecx_22 & 0x7F;
		word32 edx_34 = dwLoc10_15 + 0x01;
		dwArg08 = dwArg08 + 0x01;
		dwLoc08_14 = eax_31;
		dwLoc10_15 = edx_34;
	} while ((ecx_22 & 0x80) != 0x00);
	*dwArg04 = eax_31;
	return edx_34;
}

// 00401300: Register Eq_128 Win32CrtStartup()
DWORD Win32CrtStartup()
{
	word32 esp_18;
	word32 ebp_19;
	byte SCZO_20;
	word32 ebx_21;
	word32 esi_22;
	word32 edi_23;
	word32 eax_24;
	byte SZO_25;
	byte C_26;
	byte Z_27;
	word32 ecx_28;
	word32 edx_29;
	struct Eq_141 * fs_30;
	COMCTL32.dll!Ordinal_17();
	LoadCursorA(null, 0x7F00);
	GetCommandLineA();
	Eq_2 eax_39 = GetModuleHandleA(0x00);
	if (RegOpenKeyA((struct HKEY__ *) 0x80000002, 0x004080A8, fp - 0x28) == 0x00)
	{
		struct Eq_168 * eax_103 = globals->ptr404000;
		word32 edx_106 = globals->dw404004;
		struct Eq_168 * dwLoc08_108 = null;
		while (dwLoc08_108 < eax_103)
		{
			dwLoc08_108[0x00080801] = (struct Eq_168) (dwLoc08_108[0x00080801] ^ 0x00891100);
			dwLoc08_108 = dwLoc08_108 + 0x01;
		}
		*(fp - 100) = edx_106;
		globals->dw4080D4 = fn00401960(dwArg00);
		*(fp - 100) = (struct Eq_168 **) eax_103;
		*(fp - 0x68) = globals->dw4080D4;
		*(fp - 0x6C) = 0x00404008;
		fn004010A0(dwArg00, dwArg04, dwArg08);
		globals->ptr4080D8 = fs_30->ptr0018;
		globals->dw4080C8 = edi_23;
		globals->dw4080C4 = esi_22;
		globals->dw4080D0 = ebx_21;
		globals->ptr4080CC = fp - 0x04;
		*(fp - 100) = (union Eq_2 *) eax_39;
		word32 ecx_162 = 4199477 - eax_39;
		*(fp - 0x68) = ecx_162;
		ptr32 ebp_166 = fn00401480(dwArg00, dwArg04);
		word32 edx_169 = globals->dw4080D4;
		*(fp - 100) = edx_169;
		word32 eax_172 = fn004015F0(ebp_166, dwArg00);
		*(ebp_166 - 0x38) = 0x00;
		word32 esp_180;
		word32 ebp_181;
		byte SCZO_182;
		word32 ebx_183;
		word32 esi_184;
		word32 edi_185;
		Eq_128 eax_186;
		byte SZO_187;
		byte C_188;
		byte Z_189;
		word32 ecx_190;
		word32 edx_191;
		struct Eq_339 * fs_192;
		globals->ptr4080DC();
		return eax_186;
	}
	else
	{
		*(fp - 100) = 0x00;
		*(fp - 0x68) = 4199040;
		*(fp - 0x6C) = 0x00;
		*(fp - 0x70) = 1000;
		*(fp - 116) = (union Eq_2 *) eax_39;
		DialogBoxParamA(*(fp - 116), *(fp - 0x70), *(fp - 0x6C), *(fp - 0x68), *(fp - 100));
		return 0x00;
	}
}

// 00401480: Register word32 fn00401480(Stack Eq_3 dwArg04, Stack Eq_3 dwArg08)
word32 fn00401480(Eq_3 dwArg04, Eq_3 dwArg08)
{
	word32 edx_16 = dwArg08 + Mem0[dwArg08 + 0x3C:word32];
	globals->t4080C0 = VirtualAlloc(0x00, edx_16->t0050, 0x3000, 0x40);
	if (globals->t4080C0 != 0x00)
	{
		Eq_2 edx_74 = globals->t4080C0;
		fn00401060(edx_74, dwArg08, edx_16->t0050);
		ui32 eax_79 = globals->t4080C0 - dwArg08;
		if (edx_16->dw00A4 != 0x00)
		{
			struct Eq_409 * dwLoc0C_109 = (word32) dwArg08 + edx_16->dw00A0;
			while (dwLoc0C_109->t0004 != 0x00)
			{
				uint32 eax_124 = dwLoc0C_109->t0004 - 0x08 >> 0x01;
				word16 ecx_127[] = (char *) &dwLoc0C_109->t0004 + 0x04;
				uint32 dwLoc08_130 = 0x00;
				while (dwLoc08_130 < eax_124)
				{
					if ((word32) ecx_127[dwLoc08_130] >> 0x0C == 0x03)
						(word32) globals->t4080C0 + dwLoc0C_109->dw0000 + ((word32) ecx_127[dwLoc08_130] & 0x0FFF) = (struct Eq_454 *) ((word32) globals->t4080C0 + dwLoc0C_109->dw0000 + ((word32) ecx_127[dwLoc08_130] & 0x0FFF) + eax_79);
					dwLoc08_130 = dwLoc08_130 + 0x01;
				}
				dwLoc0C_109 = dwLoc0C_109 + Mem29[dwLoc0C_109 + 0x04:word32];
			}
		}
		word32 eax_91 = dwArg04 + Mem29[0x004080C0:word32];
		word32 esp_95;
		word32 ebp_96;
		byte SCZO_97;
		word32 esi_98;
		word32 eax_99;
		word32 ecx_100;
		word32 edx_101;
		byte Z_102;
		byte SZO_103;
		byte C_104;
		eax_91();
		return ebp_96;
	}
	else
		return ebp;
}

// 004015D0: Register Eq_476 fn004015D0(Stack Eq_2 dwArg04, Stack Eq_3 dwArg08, Register out ptr32 ebpOut)
FARPROC fn004015D0(Eq_2 dwArg04, Eq_3 dwArg08, ptr32 & ebpOut)
{
	Eq_476 eax_14 = GetProcAddress(dwArg04, dwArg08);
	word32 ebp_15;
	*ebpOut = dwArg04;
	return eax_14;
}

// 004015F0: Register word32 fn004015F0(Register ptr32 ebp, Stack Eq_3 dwArg04)
word32 fn004015F0(ptr32 ebp, Eq_3 dwArg04)
{
	word32 eax_177;
	word32 edx_13 = dwArg04 + Mem0[dwArg04 + 0x3C:word32];
	struct Eq_495 * dwLoc20_117 = &edx_13->w0014 + 0x02 + (word32) edx_13->w0014 / 0x0054;
	ptr32 ebp_191 = fp - 0x04;
	Eq_2 eax_30 = VirtualAlloc(0x00, edx_13->t0050, 0x3000, 0x40);
	if (eax_30 == 0x00)
	{
		eax_177 = 0x00;
		return eax_177;
	}
	fn00401060(eax_30, dwArg04, (word32) *((word32) dwArg04 + 0x003C) + 0x0138 + (word32) edx_13->w0006 *s 0x28);
	uint32 dwLoc0C_121 = 0x00;
	while (dwLoc0C_121 < (word32) edx_13->w0006)
	{
		if (dwLoc20_117->dw0014 != 0x00 && dwLoc20_117->dw0010 != 0x00)
			fn00401060(eax_30 + Mem0[dwLoc20_117 + 0x0C:word32], dwArg04 + Mem0[dwLoc20_117 + 0x14:word32], (uint32) ((uint64) (uint32) (Mem0[dwLoc20_117 + 0x10:word32] - 0x01 + Mem0[edx_13 + 0x3C:word32]) /u Mem0[edx_13 + 0x3C:word32]) *s Mem0[edx_13 + 0x3C:word32]);
		dwLoc20_117 = dwLoc20_117 + 0x01;
		dwLoc0C_121 = dwLoc0C_121 + 0x01;
	}
	union Eq_3 * esp_171 = fp - 0x68;
	if (CreateFileMappingA((void *) ~0x00, null, 0x04, 0x00, Mem0[eax_30 + Mem0[eax_30 + 0x3C:word32] + 0x50:word32], 0x00) == 0x00)
	{
		eax_177 = 0x00;
		return eax_177;
	}
	while (*((char *) *(ebp_191 - 0x3C) + 0x0010) != 0x00)
	{
		union Eq_3 * esp_199 = esp_171 - 0x04;
		*esp_199 = (union Eq_3 *) ((char *) *((char *) *(ebp_191 - 0x3C) + 0x0C) + *(ebp_191 - 0x24));
		*(ebp_191 - 0x10) = (union Eq_2 *) LoadLibraryA(*esp_199);
		if (**(ebp_191 - 0x3C) != 0x00)
		{
			*(ebp_191 - 0x18) = (char *) **(ebp_191 - 0x3C) + *(ebp_191 - 0x24);
			*(ebp_191 - 0x28) = (char *) *((char *) *(ebp_191 - 0x3C) + 0x0010) + *(ebp_191 - 0x24);
		}
		else
		{
			*(ebp_191 - 0x18) = (char *) *((char *) *(ebp_191 - 0x3C) + 0x0010) + *(ebp_191 - 0x24);
			*(ebp_191 - 0x28) = (char *) **(ebp_191 - 0x3C) + *(ebp_191 - 0x24);
		}
		*(ebp_191 - 0x0C) = 0x00;
		if (*((char *) *(ebp_191 - 0x3C) + 0x0010) != 0x00 && *(*(ebp_191 - 0x3C)) != 0x00)
			*(ebp_191 - 0x0C) = 0x01;
		while (true)
		{
			esp_171 = esp_199;
			if (**(ebp_191 - 0x18) == 0x00)
				break;
			if ((**(ebp_191 - 0x18) & 0x80000000) != 0x00)
			{
				*(esp_199 - 0x04) = **(ebp_191 - 0x18) & 0x7FFFFFFF;
				*(esp_199 - 0x08) = *(ebp_191 - 0x10);
				word32 eax_266 = fn004015D0(dwArg00, dwArg04, out ebp_191);
				**(ebp_191 - 0x18) = eax_266;
			}
			else
			{
				*(esp_199 - 0x04) = (char *) **(ebp_191 - 0x18) + 0x02 + *(ebp_191 - 0x24);
				*(esp_199 - 0x08) = *(ebp_191 - 0x10);
				word32 eax_281 = fn004015D0(dwArg00, dwArg04, out ebp_191);
				**(ebp_191 - 0x18) = eax_281;
			}
			if (**(ebp_191 - 0x18) == 0x00)
			{
				eax_177 = 0x00;
				return eax_177;
			}
			if (*(ebp_191 - 0x0C) != 0x00)
				**(ebp_191 - 0x28) = **(ebp_191 - 0x18);
			*(ebp_191 - 0x18) = *(ebp_191 - 0x18) + 0x04;
			*(ebp_191 - 0x28) = *(ebp_191 - 0x28) + 0x04;
		}
		*(ebp_191 - 0x3C) = *(ebp_191 - 0x3C) + 0x14;
	}
	union Eq_2 * esp_314 = esp_171 - 0x04;
	*esp_314 = (union Eq_2 *) *((char *) *(ebp_191 - 44) + 0x0034);
	*(esp_314 - 0x04) = 0x00;
	*(esp_314 - 0x08) = 0x00;
	*(esp_314 - 0x0C) = 0x00;
	*(esp_314 - 0x10) = 0x22;
	*(esp_314 - 0x14) = *(ebp_191 - 0x04);
	globals->t4080C0 = MapViewOfFileEx(*(esp_314 - 0x14), *(esp_314 - 0x10), *(esp_314 - 0x0C), *(esp_314 - 0x08), *(esp_314 - 0x04), *esp_314);
	ptr32 esp_325 = esp_314 - 0x14;
	if (globals->t4080C0 == 0x00)
	{
		*(esp_314 - 0x18) = *((char *) *(ebp_191 - 44) + 0x0034);
		ptr32 esp_364 = esp_314 - 0x18;
		if (UnmapViewOfFile(*(esp_314 - 0x18)) == 0x00)
		{
			*(esp_314 - 0x1C) = 0x8000;
			*(esp_314 - 0x20) = 0x00;
			*(esp_314 - 0x24) = *((char *) *(ebp_191 - 44) + 0x0034);
			esp_364 = esp_314 - 0x24;
			if (VirtualFree(*(esp_314 - 0x24), *(esp_314 - 0x20), *(esp_314 - 0x1C)) == 0x00)
			{
				eax_177 = 0x00;
				return eax_177;
			}
		}
		union Eq_2 * esp_375 = esp_364 - 0x04;
		*esp_375 = (union Eq_2 *) *((char *) *(ebp_191 - 44) + 0x0034);
		*(esp_375 - 0x04) = 0x00;
		*(esp_375 - 0x08) = 0x00;
		*(esp_375 - 0x0C) = 0x00;
		*(esp_375 - 0x10) = 0x22;
		*(esp_375 - 0x14) = *(ebp_191 - 0x04);
		globals->t4080C0 = MapViewOfFileEx(*(esp_375 - 0x14), *(esp_375 - 0x10), *(esp_375 - 0x0C), *(esp_375 - 0x08), *(esp_375 - 0x04), *esp_375);
		esp_325 = esp_375 - 0x14;
		if (globals->t4080C0 == 0x00)
		{
			*(esp_375 - 0x18) = 0x40;
			*(esp_375 - 0x1C) = 0x3000;
			*(esp_375 - 0x20) = *((char *) *(ebp_191 - 44) + 0x0050);
			*(esp_375 - 0x24) = *((char *) *(ebp_191 - 44) + 0x0034);
			globals->t4080C0 = VirtualAlloc(*(esp_375 - 0x24), *(esp_375 - 0x20), *(esp_375 - 0x1C), *(esp_375 - 0x18));
			esp_325 = esp_375 - 0x24;
			if (globals->t4080C0 == 0x00)
			{
				eax_177 = 0x00;
				return eax_177;
			}
		}
	}
	union Eq_2 * esp_337 = esp_325 - 0x04;
	*esp_337 = (union Eq_2 *) *((char *) *(ebp_191 - 44) + 0x0050);
	*(esp_337 - 0x04) = *(ebp_191 - 0x24);
	*(esp_337 - 0x08) = (union Eq_2 *) globals->t4080C0;
	fn00401060(dwArg00, dwArg04, dwArg08);
	*esp_337 = (union Eq_2 *) globals->t4080C0;
	fn00401930(dwArg00);
	Mem356[4227292:word32] = Mem350[0x004080C0:word32] + Mem350[Mem350[(ebp_191 - 44) + 0x00:word32] + 0x28:word32];
	*((char *) *(ebp_191 - 44) + 0x0028) = (struct Eq_900 **) globals->ptr4080DC;
	eax_177 = 0x01;
	return eax_177;
}

// 00401930: void fn00401930(Stack Eq_2 dwArg04)
void fn00401930(Eq_2 dwArg04)
{
	globals->ptr4080D8->ptr0030->t0008 = dwArg04;
}

// 00401960: Register Eq_2 fn00401960(Stack Eq_3 dwArg04)
Eq_2 fn00401960(Eq_3 dwArg04)
{
	return HeapAlloc(GetProcessHeap(), 0x00, dwArg04);
}

